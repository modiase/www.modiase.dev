#!/usr/bin/env nix-shell
#!nix-shell -i bash -p google-cloud-sdk curl

set -euo pipefail

PROJECT_ROOTDIR=$(git rev-parse --show-toplevel)

VERBOSE=false
while getopts "v" opt; do
  case $opt in
    v)
      VERBOSE=true
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      exit 1
      ;;
  esac
done

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib.sh"

run_cmd() {
  local cmd="$*"
  if [ "$VERBOSE" = true ]; then
    eval "$cmd"
  else
    eval "$cmd" > /dev/null 2>&1
  fi
}

source_env_if_exists() {
  log_info "Loading environment variables..." "env"
  pushd $PROJECT_ROOTDIR > /dev/null
  if [ -f .env ]; then
    export $(grep -v '^#' .env | xargs)
    log_success "Environment variables loaded" "env"
  else
    log_warn "No .env file found" "env"
  fi
  popd > /dev/null
}

build() {
  log_info "Starting build process..." "build"
  pushd "$PROJECT_ROOTDIR" > /dev/null

  if run_cmd "pnpm run build"; then
    log_success "Build completed successfully" "build"
  else
    log_error "Build failed" "build"
    popd > /dev/null
    exit 1
  fi

  popd > /dev/null
}

upload() {
  log_info "Uploading to Google Cloud Storage..." "upload"
  pushd "$PROJECT_ROOTDIR" > /dev/null

  if run_cmd "gsutil -m rsync -r -c -d build/ gs://www.modiase.dev"; then
    log_success "Upload completed successfully" "upload"
  else
    log_error "Upload failed" "upload"
    popd > /dev/null
    exit 1
  fi

  popd > /dev/null
}

purge_cache() {
  if [ ! -z "${CLOUDFLARE_ZONE_ID:-}" ] && [ ! -z "${CLOUDFLARE_API_TOKEN:-}" ]; then
    log_info "Purging Cloudflare cache..." "cache"
    pushd "$PROJECT_ROOTDIR" > /dev/null

    local curl_cmd="curl -X POST 'https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/purge_cache' -H 'Authorization: Bearer $CLOUDFLARE_API_TOKEN' -H 'Content-Type: application/json' --data '{\"purge_everything\":true}'"
    [ "$VERBOSE" != true ] && curl_cmd="$curl_cmd -sS -o /dev/null"

    if eval "$curl_cmd"; then
      log_success "Cache purged successfully" "cache"
    else
      log_error "Cache purge failed" "cache"
      popd > /dev/null
      exit 1
    fi

    popd > /dev/null
  else
    log_warn "Skipping cache purge - CLOUDFLARE_ZONE_ID or CLOUDFLARE_API_TOKEN not set" "cache"
  fi
}

log_info "Starting deployment process..." "deploy"
source_env_if_exists
build
upload
purge_cache
log_success "Deployment completed successfully!" "deploy"
